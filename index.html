<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advent Calendar (Supabase)</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(#b30000,#4d0000); margin:0; padding:20px; display:flex; justify-content:center; color:white; overflow-x:hidden; }
    .calendar-container { text-align:center; width:100%; max-width:900px; }
    h1 { font-size:36px; margin-bottom:18px; text-shadow:2px 2px 6px rgba(0,0,0,0.4); }
    .calendar { display:grid; grid-template-columns:repeat(5,1fr); gap:14px; margin:0 auto; }
    .day { background:#fff2cc; border-radius:14px; padding:20px 10px; text-align:center; font-size:22px; font-weight:700; color:#8b0000; cursor:not-allowed; opacity:.55; transition:transform .18s,background .18s; user-select:none; border:3px solid #b30000; box-shadow:0 6px 14px rgba(0,0,0,.25); min-height:70px; display:flex; align-items:center; justify-content:center; }
    .day.available { cursor:pointer; opacity:1; background:#ffdb99; }
    .day.current { background:#fff4cc !important; box-shadow:0 0 18px rgba(255,230,150,.9); transform:scale(1.06); opacity:1 !important; border-color:gold !important; }
    .day.opened { background:#c2f0c2 !important; cursor:pointer; opacity:1; border-color:#2d7a2d !important; }
    .modal-bg { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:40; }
    .modal { background:#fff; color:#111; padding:18px; border-radius:12px; width:clamp(300px,70vw,520px); box-shadow:0 10px 30px rgba(0,0,0,.35); border:4px solid #b30000; text-align:left; }
    .modal h2 { margin:0 0 10px 0; font-size:20px; color:#b30000; text-align:center; }
    .modal p { margin:0 0 14px 0; white-space:pre-wrap; }
    .modal img { display:block; max-width:100%; border-radius:8px; margin-top:10px; }
    .modal .controls { display:flex; gap:8px; justify-content:center; margin-top:12px; }
    .btn { background:#b30000; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#777; }
    .upload-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:8px; flex-wrap:wrap; }
    .small { font-size:13px; color:#eee; margin-top:6px; text-align:center; }
    .snowflake { position:fixed; top:-10px; color:white; opacity:.9; pointer-events:none; transform:translateY(0); animation: fall linear infinite; z-index:10; }
    @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(115vh) rotate(180deg); } }
    @media (max-width:560px){ .day{padding:14px;font-size:20px; min-height:64px;} h1{font-size:28px;} }
  </style>
</head>
<body>
  <div class="calendar-container">
    <h1>üéÑ Christmas Advent Calendar üéÅ</h1>
    <div class="calendar" id="calendar"></div>
    <div class="small">Tip: only the current day's box can be opened (unless already opened). Photos you upload show when you re-open that day's modal.</div>
  </div>

  <div class="modal-bg" id="modalBg" role="dialog" aria-modal="true">
    <div class="modal" id="modal">
      <h2 id="modalTitle">Day</h2>
      <p id="modalContent"></p>

      <div id="photoArea" style="text-align:center;">
        <img id="uploadedPhoto" style="display:none;" alt="Uploaded photo" />
        <div class="upload-row" id="uploadRow" style="display:none;">
          <input id="photoUpload" type="file" accept="image/*" />
          <button id="uploadBtn" class="btn">Upload photo</button>
        </div>
        <div id="uploadStatus" class="small" style="display:none;"></div>
      </div>

      <div class="controls">
        <button class="btn" id="closeBtn">Close</button>
        <button class="btn secondary" id="deletePhotoBtn" style="display:none;">Remove photo</button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Supabase client (ES module via CDN)
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ---------- CONFIG (you already provided these) ----------
    const SUPABASE_URL = 'https://iamogjtfqfvhgbmlefeg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhbW9nanRmcWZ2aGdibWxlZmVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjg2OTQsImV4cCI6MjA3OTk0NDY5NH0.h8HlGGizch5BcQtr4rO_v1ufVRVvfa4mDui7uVwr5YU';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- UI refs ----------
    const calendar = document.getElementById('calendar');
    const modalBg = document.getElementById('modalBg');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const uploadedPhoto = document.getElementById('uploadedPhoto');
    const uploadRow = document.getElementById('uploadRow');
    const photoUpload = document.getElementById('photoUpload');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const closeBtn = document.getElementById('closeBtn');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');

    // ---------- App variables ----------
    const USER_ID = 'boyfriend'; // static id so all devices read/write the same user
    const TEST_MODE = true;     // set true to force date for testing
    const TEST_MONTH = 12;
    const TEST_DAY = 3;
    const now = TEST_MODE ? new Date(2020, TEST_MONTH - 1, TEST_DAY) : new Date();
    const month = now.getMonth() + 1;
    const day = now.getDate();

    const messages = {
      1: "Good morning, love! Today, take a moment to smile and know that I‚Äôm thinking of you. You‚Äôre amazing.",
      2: "Send me a funny picture today ‚Äî I want to see that beautiful smile!",
      3: "Take a moment to relax and do something that makes you happy, just for you.",
      4: "Write down three things you‚Äôre proud of today ‚Äî you‚Äôre incredible, and I love you.",
      5: "Surprise me with a sweet message later, just because‚Ä¶ you make my day every day.",
      6: "Think of 5 things you are grateful for today ‚Äî I hope one of them is us üíñ.",
      7: "üïØÔ∏è First Sunday of Advent ‚Äî light the first candle on your wreath and think of the joy coming this season.",
      8: "Take a short walk outside and breathe deeply ‚Äî I‚Äôll be thinking of you while you do.",
      9: "Send me a song that makes you smile today ‚Äî I want to feel your vibes even from afar.",
      10: "Do something creative today, even if it‚Äôs small ‚Äî draw, write, or just doodle. I love your imagination.",
      11: "Treat yourself to your favorite snack or drink ‚Äî you deserve it, sweetheart.",
      12: "Think of a memory we shared that makes you laugh and carry that happiness with you today.",
      13: "Write a little note to yourself reminding how amazing and strong you are ‚Äî and yes, I agree ‚ù§Ô∏è.",
      14: "üïØÔ∏è Second Sunday of Advent ‚Äî light the second candle on your wreath and think of all the warmth around you.",
      15: "Take 10 minutes today just for yourself ‚Äî read, meditate, or simply enjoy a quiet moment.",
      16: "Send me a voice note saying something silly ‚Äî I love hearing your voice.",
      17: "Do one small act of kindness today, whether for someone else or yourself ‚Äî spread joy.",
      18: "Think about one dream you want to achieve ‚Äî I believe in you completely.",
      19: "Treat yourself to something cozy tonight ‚Äî maybe a warm drink or comfy socks.",
      20: "Write a short list of things that make you happy ‚Äî I hope our love is on there somewhere üíï.",
      21: "üïØÔ∏è Third Sunday of Advent ‚Äî light the third candle on your wreath and reflect on the love in your life.",
      22: "üíå Happy 1-year anniversary, my love! üéâ‚ù§Ô∏è\nI still remember the moment we met like it was yesterday, and every day since has been a beautiful adventure with you. Thank you for filling my life with laughter, love, and warmth. Today I celebrate us ‚Äî every smile, every hug, every little moment that makes us ‚Äòus‚Äô. I love you more than words can say, and I can‚Äôt wait for all the memories we'll create together. üíñ",
      23: "Take a moment today to call or text someone you love ‚Äî share some joy.",
      24: "Tonight is Christmas Eve! Take a quiet moment and remember how much I love you. I can‚Äôt wait for tomorrow!",
      25: "Merry Christmas, my love! Thank you for being the most wonderful part of my life. I love you endlessly üíñ."
    };

    // local caches
    let openedDays = [];
    let photosCache = {}; // photosCache[day] = { url, path }

    // ---------- Helpers: fetch opened days & photos ----------
    async function loadOpenedDays() {
      try {
        const { data, error } = await supabase
          .from('opened_days')
          .select('day')
          .eq('user_id', USER_ID);

        if (error) throw error;
        openedDays = (data || []).map(r => r.day);
      } catch (err) {
        console.warn('loadOpenedDays error', err);
        openedDays = []; // keep local state
      }
    }

    async function loadPhotos() {
      try {
        const { data, error } = await supabase
          .from('photos')
          .select('day, url, path')
          .eq('user_id', USER_ID);

        if (error) throw error;
        photosCache = {};
        (data || []).forEach(r => { photosCache[r.day] = { url: r.url, path: r.path }; });
      } catch (err) {
        console.warn('loadPhotos error', err);
        photosCache = {};
      }
    }

    // initial load and listeners (polling simple approach)
    async function initialLoadAndRender() {
      await Promise.all([loadOpenedDays(), loadPhotos()]);
      renderCalendar();
    }
    initialLoadAndRender();

    // optionally, listen for DB changes in realtime (Supabase Realtime)
    // For simplicity and reliability we reload every ~4s in background so changes appear quickly
    setInterval(async () => {
      await Promise.all([loadOpenedDays(), loadPhotos()]);
      renderCalendar();
      if (currentModalDay) showPhotoForDay(currentModalDay);
    }, 4000);

    // ---------- UI rendering ----------
    function renderCalendar() {
      calendar.innerHTML = '';
      for (let i=1; i<=25; i++) {
        const box = document.createElement('div');
        box.className = 'day';
        box.textContent = i;
        const isOpened = openedDays.includes(i);
        if (isOpened) {
          box.classList.add('opened');
          box.onclick = () => openModal(i);
        } else if (month === 12 && i === day) {
          box.classList.add('available', 'current');
          box.onclick = () => openToday(i);
        } else {
          // locked
        }
        calendar.appendChild(box);
      }
    }

    // ---------- Mark opened ----------
    async function openToday(dayNumber) {
      if (!openedDays.includes(dayNumber)) {
        try {
          // insert row if not exists
          const { error } = await supabase
            .from('opened_days')
            .insert([{ user_id: USER_ID, day: dayNumber }], { upsert: true });

          if (error) throw error;
        } catch (err) {
          console.warn('Failed to save opened day', err);
        }
        // local optimistic update
        openedDays = Array.from(new Set([...openedDays, dayNumber])).sort((a,b)=>a-b);
      }
      openModal(dayNumber);
      renderCalendar();
    }

    // ---------- Modal + photos ----------
    let currentModalDay = null;

    function openModal(dayNumber) {
      currentModalDay = dayNumber;
      modalTitle.textContent = `Day ${dayNumber}`;
      modalContent.textContent = messages[dayNumber] || 'No message yet.';
      uploadStatus.style.display = 'none';
      photoUpload.value = '';
      uploadRow.style.display = openedDays.includes(dayNumber) ? 'flex' : 'none';
      showPhotoForDay(dayNumber);
      modalBg.style.display = 'flex';
    }

    function showPhotoForDay(dayNumber) {
      const rec = photosCache[dayNumber];
      if (rec && rec.url) {
        uploadedPhoto.src = rec.url;
        uploadedPhoto.style.display = 'block';
        deletePhotoBtn.style.display = 'inline-block';
      } else {
        uploadedPhoto.style.display = 'none';
        deletePhotoBtn.style.display = 'none';
      }
    }

    // ---------- Upload photo ----------
    uploadBtn.addEventListener('click', async () => {
      const file = photoUpload.files[0];
      if (!file || !currentModalDay) {
        uploadStatus.style.display = 'block';
        uploadStatus.textContent = 'Select an image first.';
        setTimeout(()=>uploadStatus.style.display='none',2000);
        return;
      }

      uploadStatus.style.display = 'block';
      uploadStatus.textContent = 'Uploading...';

      try {
        // build storage path: users/<USER_ID>/day<N>/<timestamp>_<filename>
        const timestamp = Date.now();
        const filename = `${timestamp}_${file.name}`;
        const cleanName = filename.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\.-]/g, '');
        const path = `users/${USER_ID}/day${currentModalDay}/${cleanName}`;

        // upload to storage bucket named 'photos'
        const { data: uploadData, error: uploadErr } = await supabase.storage
          .from('photos')
          .upload(path, file, { cacheControl: '3600', upsert: true });

        if (uploadErr) throw uploadErr;

        // get public URL (bucket must be public)
        const { data: urlData } = supabase.storage.from('photos').getPublicUrl(path);
        const publicUrl = urlData.publicUrl;

        // persist URL + path in photos table
        const { error: dbErr } = await supabase.from('photos').upsert([
          { user_id: USER_ID, day: currentModalDay, url: publicUrl, path }
        ], { onConflict: 'day' });

        if (dbErr) throw dbErr;

        // update cache & UI
        photosCache[currentModalDay] = { url: publicUrl, path };
        showPhotoForDay(currentModalDay);
        uploadStatus.textContent = 'Uploaded!';
        setTimeout(()=>uploadStatus.style.display='none',1800);
      } catch (err) {
        console.error('upload error', err);
        uploadStatus.textContent = 'Upload failed (see console).';
      }
    });

    // ---------- Delete photo (remove DB pointer and storage object if present) ----------
    deletePhotoBtn.addEventListener('click', async () => {
      if (!currentModalDay) return;
      const rec = photosCache[currentModalDay];
      if (!rec) {
        uploadStatus.style.display = 'block';
        uploadStatus.textContent = 'No photo to remove.';
        setTimeout(()=>uploadStatus.style.display='none',2000);
        return;
      }

      uploadStatus.style.display = 'block';
      uploadStatus.textContent = 'Removing...';

      try {
        // delete storage object if we have path
        if (rec.path) {
          const { error: delErr } = await supabase.storage.from('photos').remove([rec.path]);
          if (delErr) console.warn('storage delete warning', delErr);
        }

        // remove DB row
        const { error: dbErr } = await supabase.from('photos').delete()
          .match({ user_id: USER_ID, day: currentModalDay });

        if (dbErr) throw dbErr;

        delete photosCache[currentModalDay];
        showPhotoForDay(currentModalDay);
        uploadStatus.textContent = 'Removed.';
        setTimeout(()=>uploadStatus.style.display='none',1600);
      } catch (err) {
        console.error('delete photo err', err);
        uploadStatus.textContent = 'Failed to remove photo.';
      }
    });

    // ---------- close modal ----------
    closeBtn.addEventListener('click', () => { modalBg.style.display='none'; currentModalDay=null; });
    modalBg.addEventListener('click', (e) => { if (e.target === modalBg) { modalBg.style.display='none'; currentModalDay=null; } });

    // ---------- Snowflakes ----------
    function createSnowflakes() {
      setInterval(() => {
        const s = document.createElement('div');
        s.className = 'snowflake';
        s.textContent = '‚ùÑ';
        s.style.left = (Math.random()*100) + 'vw';
        s.style.fontSize = (10 + Math.random()*22) + 'px';
        s.style.opacity = (0.6 + Math.random()*0.4).toString();
        s.style.animationDuration = (6 + Math.random()*7) + 's';
        document.body.appendChild(s);
        setTimeout(()=>s.remove(), 16000);
      }, 600);
    }
    createSnowflakes();

    // initial render (in case DB load delayed)
    renderCalendar();
  </script>
</body>
</html>




