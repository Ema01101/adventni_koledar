<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÑ Christmas Advent Calendar üéÅ</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(#b30000, #4d0000);
      margin: 0; padding: 20px;
      color: white;
      display: flex; justify-content: center;
      background-attachment: fixed;
    }
    h1 {
      font-size: 36px;
      margin-bottom: 20px;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.4);
    }

    .calendar-container { text-align: center; }
    .calendar {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      max-width: 700px; width: 100%;
    }

    .day {
      background: #fff2cc;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #8b0000;
      cursor: not-allowed;
      opacity: 0.55;
      transition: transform 0.3s, background 0.3s;
      user-select: none;
      border: 3px solid #b30000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .day.available { cursor: pointer; opacity: 1; background: #ffdb99; }
    .day.current { background: #fff4cc !important; box-shadow: 0 0 18px rgba(255, 230, 150, 0.9); transform: scale(1.07); opacity: 1 !important; border-color: gold !important; }
    .day.opened { background: #c2f0c2 !important; cursor: pointer; opacity: 1; border-color: #2d7a2d !important; }

    .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:none; justify-content: center; align-items:center; }
    .modal { background:white; padding:30px; border-radius:12px; text-align:center; max-width:400px; color:black; border:4px solid #b30000; }
    .close { margin-top:20px; padding:10px 20px; cursor:pointer; border:none; background:#b30000; color:white; border-radius:8px; font-size:16px; }
    input[type="file"] { margin-top: 10px; }
    img.uploaded-photo { max-width: 100%; margin-top:10px; border-radius:8px; }
    .snowflake { position: fixed; top: -10px; color: white; opacity: 0.8; animation: fall linear infinite; }
    @keyframes fall { 0% { transform: translateY(0); } 100% { transform: translateY(110vh); } }
  </style>
</head>
<body>
  <div class="calendar-container">
    <h1>üéÑ Christmas Advent Calendar üéÅ</h1>
    <div class="calendar" id="calendar"></div>
  </div>

  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <h2 id="modalTitle"></h2>
      <p id="modalContent"></p>
      <input type="file" id="photoInput" />
      <div id="uploadedPhotos"></div>
      <button class="close" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    // --- Supabase config ---
    const SUPABASE_URL = "https://iamogjtfqfvhgbmlefeg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhbW9nanRmcWZnbGJlbmZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjg2OTQsImV4cCI6MjA3OTk0NDY5NH0.h8HlGGizch5BcQtr4rO_v1ufVRVvfa4mDui7uVwr5YU";
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const USER_ID = "boyfriend";
    const calendar = document.getElementById("calendar");
    const modalBg = document.getElementById("modalBg");
    const modalTitle = document.getElementById("modalTitle");
    const modalContent = document.getElementById("modalContent");
    const photoInput = document.getElementById("photoInput");
    const uploadedPhotosDiv = document.getElementById("uploadedPhotos");

    // --- Date ---
    const today = new Date();
    /*let currentMonth = today.getMonth() + 1;
    let currentDay = today.getDate();*/
    let currentDay = 25; // For testing purposes, set to 25. Change to 'today.getDate()' for real use.
    let currentMonth = 12;

    // --- Messages ---
    const messages = {
      1:"Message for Day 1 ‚ô•",2:"Message for Day 2 ‚ô•",3:"Message for Day 3 ‚ô•",4:"Do something kind for yourself today ‚ô•",
      5:"Think of 5 things you are grateful for ‚ô•",6:"Relax and listen to your favorite song today",
      7:"Light the first candle of your Advent wreath üïØÔ∏è",8:"Write a sweet note to yourself",9:"Take a little walk outside today",
      10:"Give yourself extra hugs today ‚ô•",11:"Do a small creative project",12:"Take 10 minutes to meditate",
      13:"Surprise someone with a kind message",14:"Light the second candle of your Advent wreath üïØÔ∏è",15:"Spend extra time on your favorite hobby",
      16:"Think about your happiest memory this year",17:"Make a hot drink and relax",18:"Write a little poem for me ‚ô•",
      19:"Take a small self-care break",20:"Call a loved one and tell them you care",
      21:"Light the third candle of your Advent wreath üïØÔ∏è",22:"Happy 1 year anniversary, my love! ‚ù§Ô∏è",
      23:"Treat yourself to your favorite snack today",24:"Reflect on the past year with gratitude",25:"Merry Christmas, my love! üéÑ‚ô•"
    };

    let openedDays = [];

    // --- Fetch opened days ---
    async function fetchOpenedDays(){
      const { data, error } = await supabase.from('opened_days').select('*').eq('user_id', USER_ID);
      if(error){console.error("Fetch opened_days error:", error);}
      else openedDays = data.map(row => row.day);
      renderCalendar();
    }

    // --- Render calendar ---
    function renderCalendar(){
      calendar.innerHTML="";
      for(let i=1;i<=25;i++){
        const box=document.createElement("div");
        box.classList.add("day");
        box.textContent=i;

        const alreadyOpened = openedDays.includes(i);

        if(alreadyOpened){
          box.classList.add("opened");
          box.onclick = ()=>openModal(i);
        } else if(i <= currentDay){
          box.classList.add("available");
          if(i === currentDay) box.classList.add("current");
          box.onclick = ()=>openDay(i);
        }

        calendar.appendChild(box);
      }
    }

    // --- Open a day ---
    async function openDay(day){
      if(!openedDays.includes(day)){
        const { error } = await supabase.from('opened_days').insert([{user_id: USER_ID, day}]);
        if(error) console.error("Insert opened_days error:", error);
        openedDays.push(day);
      }
      openModal(day);
    }

    // --- Open modal ---
    async function openModal(day){
      modalTitle.textContent = `Day ${day}`;
      modalContent.textContent = messages[day] || "No message yet.";
      uploadedPhotosDiv.innerHTML="";
      photoInput.value="";
      modalBg.style.display="flex";

      // Load photos
      const { data, error } = await supabase.from('photos').select('*').eq('user_id', USER_ID).eq('day', day);
      if(error) console.error("Fetch photos error:", error);
      else data.forEach(p=>{
        const img=document.createElement("img");
        img.src=p.url;
        img.classList.add("uploaded-photo");
        uploadedPhotosDiv.appendChild(img);
      });

      // Upload photo
      photoInput.onchange = async () => {
        const file = photoInput.files[0];
        if(!file) return;

        const timestamp = Date.now();
        const cleanName = file.name.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\.-]/g,'');
        const path = `users/${USER_ID}/day${day}/${timestamp}_${cleanName}`;

        const { data: uploadData, error: uploadError } = await supabase.storage.from('photos').upload(path,file,{upsert:true});
        if(uploadError){console.error("Upload error",uploadError); alert("Upload failed!"); return;}

        const { data: urlData } = supabase.storage.from('photos').getPublicUrl(path);
        const url = urlData.publicUrl;

        const { error: dbError } = await supabase.from('photos').insert([{user_id:USER_ID,day,url,path}]);
        if(dbError) console.error("DB insert error:", dbError);

        const img=document.createElement("img");
        img.src=url;
        img.classList.add("uploaded-photo");
        uploadedPhotosDiv.appendChild(img);
      };
    }

    function closeModal(){ modalBg.style.display="none"; }

    // --- Snowflakes ---
    function createSnowflakes(){
      setInterval(()=>{
        const snowflake=document.createElement('div');
        snowflake.classList.add('snowflake');
        snowflake.textContent='‚ùÑ';
        snowflake.style.left=Math.random()*100+'vw';
        snowflake.style.animationDuration=5+Math.random()*7+'s';
        snowflake.style.fontSize=10+Math.random()*20+'px';
        document.body.appendChild(snowflake);
        setTimeout(()=>snowflake.remove(),12000);
      },400);
    }

    createSnowflakes();
    fetchOpenedDays();
  </script>
</body>
</html>





